<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>Интеллектуальный ввод адреса</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 720px; }
  h2 { margin-bottom: 12px; }
  label { display:block; margin-bottom:6px; font-weight:600; }
  .input-wrap { margin-bottom:16px; position:relative; }
  input[type="text"] { width:100%; padding:8px 10px; font-size:14px; box-sizing:border-box; }
  .suggestions { border:1px solid #ccc; background:#fff; position:absolute; max-height:250px; overflow:auto; margin-top:2px; border-radius:4px; z-index:999; width:100%; }
  .suggestion-item { padding:8px 10px; cursor:pointer; border-bottom:1px solid #eee; }
  .suggestion-item:hover { background:#f2f2f2; }
</style>
</head>
<body>
  <h2>Поиск адреса</h2>

  <div class="input-wrap">
    <label for="from">Откуда:</label>
    <input id="from" type="text" placeholder="Начните вводить адрес..." autocomplete="off" />
    <div id="from-suggestions" class="suggestions" style="display:none;"></div>
  </div>

  <div class="input-wrap">
    <label for="to">Куда:</label>
    <input id="to" type="text" placeholder="Начните вводить адрес..." autocomplete="off" />
    <div id="to-suggestions" class="suggestions" style="display:none;"></div>
  </div>

<script>
const API_URL = "http://127.0.0.1:5000/api";

// Настройка поля ввода с подсказками
function setupAddressInput(inputId) {
  let chain = { parentGuid:"", levels:[] };
  const input = document.getElementById(inputId);
  const suggBox = document.getElementById(`${inputId}-suggestions`);

  async function fetchSuggestions(query, parentGuid="") {
    const res = await fetch(`${API_URL}/autocomplete?query=${encodeURIComponent(query)}&parentGuid=${encodeURIComponent(parentGuid)}`);
    return await res.json();
  }

  async function fetchFull(guid) {
    const res = await fetch(`${API_URL}/full?guid=${encodeURIComponent(guid)}`);
    return await res.json();
  }

  function renderSuggestions(items) {
    suggBox.innerHTML = "";
    if (!items.length) { suggBox.style.display="none"; return; }
    items.forEach(it => {
      const div = document.createElement("div");
      div.className="suggestion-item";
      div.textContent = `${it.shortName||""} ${it.formalName}`;
      div.onclick = async () => {
        chain.levels.push(it);
        chain.parentGuid = it.fiasGuid;
        input.value = chain.levels.map(x=> (x.shortName?x.shortName+" ":"")+x.formalName).join(", ") + ", ";
        suggBox.style.display="none";

        // если дом или квартира — можно получить полные данные
        if (it.level==="8" || it.level==="9") {
          const full = await fetchFull(it.fiasGuid);
          console.log("FULL ADDRESS", inputId, full);
          // здесь можно отправить JSON на сервер
        }
      };
      suggBox.appendChild(div);
    });
    suggBox.style.display="block";
  }

  input.addEventListener("input", async (e) => {
    const v = e.target.value.split(",").pop().trim();
    if (v.length<1) { suggBox.style.display="none"; return; }
    const items = await fetchSuggestions(v, chain.parentGuid);
    renderSuggestions(items);
  });

  input.addEventListener("keydown", async (e) => {
    if (e.key==="Enter") {
      e.preventDefault();
      const v = input.value.split(",").pop().trim();
      const items = await fetchSuggestions(v, chain.parentGuid);
      if (items.length) {
        const it = items[0];
        chain.levels.push(it);
        chain.parentGuid = it.fiasGuid;
        input.value = chain.levels.map(x=> (x.shortName?x.shortName+" ":"")+x.formalName).join(", ") + ", ";
        suggBox.style.display="none";
        if (it.level==="8" || it.level==="9") {
          const full = await fetchFull(it.fiasGuid);
          console.log("FULL ADDRESS", inputId, full);
        }
      }
    }
  });
}

setupAddressInput("from");
setupAddressInput("to");
</script>
</body>
</html>
