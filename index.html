<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Поиск адреса</title>
<style>
body { font-family: Arial; padding: 20px; }
.input-container { position: relative; margin-bottom: 20px; }
input { width: 300px; padding: 5px; margin-bottom: 5px; }
.suggestions { border: 1px solid #ccc; max-height: 150px; overflow-y: auto; width: 310px; position: absolute; background: #fff; z-index: 1000; }
.suggestion-item { padding: 5px; cursor: pointer; }
.suggestion-item:hover { background-color: #eee; }
.address-level { margin-bottom: 10px; padding: 5px; background: #f5f5f5; }
</style>
</head>
<body>

<h2>Поиск адреса</h2>

<div class="input-container">
    <label>Откуда:</label><br>
    <!-- Блок для отображения выбранных уровней адреса -->
    <div id="from-address-levels"></div>
    <input id="from" type="text" autocomplete="off" placeholder="Начните вводить область...">
    <div id="from-suggestions" class="suggestions"></div>
</div>

<div class="input-container">
    <label>Куда:</label><br>
    <!-- Блок для отображения выбранных уровней адреса -->
    <div id="to-address-levels"></div>
    <input id="to" type="text" autocomplete="off" placeholder="Начните вводить область...">
    <div id="to-suggestions" class="suggestions"></div>
</div>

<script>
const API_URL = "http://127.0.0.1:5000/api";

// Храним историю выбора для каждого поля ввода
const addressChains = {
    from: { parentGuid: "", levels: [] },
    to: { parentGuid: "", levels: [] }
};

// Обновляем отображение выбранных уровней адреса
function updateAddressLevelsDisplay(field) {
    const container = document.getElementById(`${field}-address-levels`);
    const chain = addressChains[field];
    
    container.innerHTML = '';
    chain.levels.forEach((level, index) => {
        const div = document.createElement('div');
        div.className = 'address-level';
        div.textContent = `${level.shortName} ${level.formalName}`;
        
        // Делаем уровни кликабельными для возврата на предыдущий шаг
        div.style.cursor = 'pointer';
        div.onclick = () => {
            // Обрезаем цепочку до выбранного уровня
            addressChains[field].levels = addressChains[field].levels.slice(0, index);
            addressChains[field].parentGuid = index > 0 ? 
                addressChains[field].levels[index - 1].fiasGuid : "";
            updateAddressLevelsDisplay(field);
            document.getElementById(field).value = '';
            // Обновляем подсказку в placeholder
            document.getElementById(field).placeholder = index > 0 ? 
                `Введите ${getNextLevelName(addressChains[field].levels[index - 1].level)}...` : 
                "Начните вводить область...";
        };
        
        container.appendChild(div);
    });
}

// Определяем следующий уровень для подсказки пользователю
function getNextLevelName(currentLevel) {
    const levelMap = {
        1: 'район',
        4: 'город', 
        6: 'поселение', 
        7: 'улицу', 
        8: 'дом', 
        9: 'квартиру'
    };
    return levelMap[currentLevel + 1] || 'следующий уровень';
}

// Запрос к API для получения подсказок
async function fetchSuggestions(query, parentGuid = "") {
    try {
        const res = await fetch(`${API_URL}/autocomplete?query=${encodeURIComponent(query)}&parentGuid=${parentGuid}`);
        const data = await res.json();
        return Array.isArray(data) ? data : [];
    } catch (e) {
        console.error('Ошибка при запросе подсказок:', e);
        return [];
    }
}

// Настраиваем автодополнение для поля ввода
function setupAutocomplete(inputId, field) {
    const input = document.getElementById(inputId);
    const suggestionsBox = document.getElementById(`${inputId}-suggestions`);

    // Обработчик ввода текста
    input.addEventListener("input", async () => {
        const query = input.value.trim();
        // Ждем пока пользователь введет хотя бы 2 символа
        if (query.length < 2) {
            suggestionsBox.innerHTML = "";
            return;
        }

        // Запрашиваем подсказки с учетом родительского GUID
        const suggestions = await fetchSuggestions(query, addressChains[field].parentGuid);
        
        // Очищаем предыдущие подсказки
        suggestionsBox.innerHTML = "";
        
        // Добавляем новые подсказки
        suggestions.forEach(item => {
            const div = document.createElement("div");
            div.className = "suggestion-item";
            div.textContent = `${item.shortName} ${item.formalName}`.trim();
            div.dataset.guid = item.fiasGuid;
            div.dataset.level = item.level;

            // Обработчик клика по подсказке
            div.addEventListener("click", () => {
                // Сохраняем выбранный элемент в историю
                addressChains[field].levels.push({
                    fiasGuid: item.fiasGuid,
                    formalName: item.formalName,
                    shortName: item.shortName,
                    level: parseInt(item.level)
                });
                // Обновляем родительский GUID для следующего запроса
                addressChains[field].parentGuid = item.fiasGuid;
                
                // Обновляем интерфейс
                updateAddressLevelsDisplay(field);
                input.value = "";
                input.placeholder = `Введите ${getNextLevelName(item.level)}...`;
                suggestionsBox.innerHTML = "";
            });

            suggestionsBox.appendChild(div);
        });
    });

    // Скрываем подсказки при клике вне поля ввода
    document.addEventListener("click", (event) => {
        if (!input.contains(event.target) && !suggestionsBox.contains(event.target)) {
            suggestionsBox.innerHTML = "";
        }
    });
}

// Инициализируем автодополнение для обоих полей
setupAutocomplete("from", "from");
setupAutocomplete("to", "to");
</script>

</body>
</html>